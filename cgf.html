<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Gastos Familiar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: all 0.3s ease-in-out; }
        .card:hover { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1); }
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-weight: 600; color: white; transition: background-color 0.2s; cursor: pointer; }
        .btn-primary { background-color: #4f46e5; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #64748b; }
        .btn-secondary:hover { background-color: #475569; }
        .btn-danger { background-color: #dc2626; }
        .btn-danger:hover { background-color: #b91c1c; }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; max-width: 90%; width: 500px; max-height: 90vh; overflow-y: auto; }
        #report-content { font-family: 'Courier New', Courier, monospace; }
        .action-btn { background: none; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-800">Controle de Gastos Familiar</h1>
            <p class="text-lg text-gray-500 mt-2">Gerencie as finanças da sua família de forma simples e colaborativa.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Coluna da Esquerda: Membros e Gastos -->
            <div class="lg:col-span-1 space-y-8">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2"><i class="fas fa-users mr-2 text-indigo-500"></i>Membros da Família</h2>
                    <form id="add-member-form" class="space-y-4">
                        <input type="text" id="member-name" placeholder="Nome do membro" class="form-input" required>
                        <input type="number" id="member-salary" placeholder="Salário (R$)" class="form-input" min="0" step="0.01" required>
                        <input type="number" id="member-closing-day" placeholder="Dia de Fechamento do Cartão (1-31)" class="form-input" min="1" max="31">
                        <button type="submit" class="btn btn-primary w-full justify-center"><i class="fas fa-plus"></i> Adicionar Membro</button>
                    </form>
                    <div id="members-list" class="mt-6 space-y-3"></div>
                </div>

                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2"><i class="fas fa-money-bill-wave mr-2 text-indigo-500"></i>Adicionar Gasto</h2>
                    <form id="add-expense-form" class="space-y-4">
                        <select id="expense-member" class="form-input" required><option value="">Selecione um membro</option></select>
                        <input type="text" id="expense-description" placeholder="Descrição do gasto" class="form-input" required>
                        <input type="text" id="expense-store" placeholder="Loja/Local (Opcional)" class="form-input">
                        <input type="date" id="expense-date" class="form-input" required>
                        <input type="number" id="expense-value" placeholder="Valor (R$)" class="form-input" min="0" step="0.01" required>
                        <input type="number" id="expense-installments" placeholder="Nº de Parcelas (1 = à vista)" class="form-input" min="1">
                        <button type="submit" class="btn btn-primary w-full justify-center"><i class="fas fa-cart-plus"></i> Registrar Gasto</button>
                    </form>
                </div>
            </div>

            <!-- Coluna da Direita: Relatórios e Gastos -->
            <div class="lg:col-span-2">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2"><i class="fas fa-chart-line mr-2 text-indigo-500"></i>Relatórios e Gastos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <label for="filter-member" class="block text-sm font-medium text-gray-700 mb-1">Membro</label>
                            <select id="filter-member" class="form-input"><option value="all">Todos os membros</option></select>
                        </div>
                        <div>
                           <label for="filter-month" class="block text-sm font-medium text-gray-700 mb-1">Mês</label>
                            <select id="filter-month" class="form-input"></select>
                        </div>
                        <div>
                           <label for="filter-year" class="block text-sm font-medium text-gray-700 mb-1">Ano</label>
                            <select id="filter-year" class="form-input"></select>
                        </div>
                    </div>

                    <!-- Seção de Resumo -->
                    <div id="summary-section" class="mb-6"></div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-sm font-semibold text-gray-600">Membro</th>
                                    <th class="p-3 text-sm font-semibold text-gray-600">Descrição</th>
                                    <th class="p-3 text-sm font-semibold text-gray-600">Data</th>
                                    <th class="p-3 text-sm font-semibold text-gray-600 text-right">Valor</th>
                                    <th class="p-3 text-sm font-semibold text-gray-600 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-table-body"></tbody>
                        </table>
                        <div id="no-expenses-message" class="text-center py-8 text-gray-500 hidden"><i class="fas fa-folder-open fa-3x mb-3"></i><p>Nenhum gasto encontrado.</p></div>
                    </div>
                    <div id="report-button-container" class="mt-6"></div>
                    <div class="mt-8 pt-6 border-t flex flex-col md:flex-row gap-4">
                        <button id="backup-btn" class="btn btn-secondary justify-center flex-1"><i class="fas fa-download"></i> Fazer Backup</button>
                        <label for="restore-input" class="btn btn-secondary justify-center flex-1"><i class="fas fa-upload"></i> Restaurar Backup</label>
                        <input type="file" id="restore-input" class="hidden" accept=".json">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="report-modal" class="modal-overlay hidden">
        <div class="modal-content !w-[800px]">
            <div id="report-content" class="p-4 border border-dashed border-gray-400"></div>
            <div class="mt-6 flex justify-end space-x-4">
                <button class="btn btn-secondary close-modal-btn"><i class="fas fa-times"></i> Fechar</button>
                <button id="print-pdf-btn" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Gerar PDF / Imprimir</button>
            </div>
        </div>
    </div>

    <div id="edit-member-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Editar Membro</h2>
            <form id="edit-member-form" class="space-y-4">
                <input type="hidden" id="edit-member-id">
                <input type="text" id="edit-member-name" placeholder="Nome do membro" class="form-input" required>
                <input type="number" id="edit-member-salary" placeholder="Salário (R$)" class="form-input" min="0" step="0.01" required>
                <input type="number" id="edit-member-closing-day" placeholder="Dia de Fechamento (1-31)" class="form-input" min="1" max="31">
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-expense-modal" class="modal-overlay hidden">
        <div class="modal-content">
             <h2 class="text-xl font-bold mb-4">Editar Gasto</h2>
             <div id="edit-installment-info" class="text-sm text-gray-600 bg-gray-100 p-2 rounded-md mb-4 hidden"></div>
             <form id="edit-expense-form" class="space-y-4">
                <input type="hidden" id="edit-expense-id">
                <select id="edit-expense-member" class="form-input" required></select>
                <input type="text" id="edit-expense-description" placeholder="Descrição" class="form-input" required>
                <input type="text" id="edit-expense-store" placeholder="Loja/Local" class="form-input">
                <input type="date" id="edit-expense-date" class="form-input" required>
                <input type="number" id="edit-expense-value" placeholder="Valor (R$)" class="form-input" min="0" step="0.01" required>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="confirm-title" class="text-xl font-bold mb-4">Você tem certeza?</h2>
            <p id="confirm-message" class="text-gray-600 mb-6">Esta ação não pode ser desfeita.</p>
            <div id="confirm-buttons" class="flex justify-end gap-4">
                <!-- Buttons are dynamically injected here -->
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT (localStorage) ---
            let membersData = [];
            let expensesData = [];
            const APP_STORAGE_KEY = 'familyExpensesApp';

            const initialDataFromXLSX = {
                members: [],
                expenses: []
            };
            
            // --- DOM ELEMENTS ---
            const addMemberForm = document.getElementById('add-member-form');
            const membersListDiv = document.getElementById('members-list');
            const expenseMemberSelect = document.getElementById('expense-member');
            const filterMemberSelect = document.getElementById('filter-member');
            const addExpenseForm = document.getElementById('add-expense-form');
            const expensesTableBody = document.getElementById('expenses-table-body');
            const noExpensesMessage = document.getElementById('no-expenses-message');
            const filterMonthSelect = document.getElementById('filter-month');
            const filterYearSelect = document.getElementById('filter-year');
            const reportModal = document.getElementById('report-modal');
            const reportContent = document.getElementById('report-content');
            const printPdfBtn = document.getElementById('print-pdf-btn');
            const reportButtonContainer = document.getElementById('report-button-container');
            const backupBtn = document.getElementById('backup-btn');
            const restoreInput = document.getElementById('restore-input');
            const summarySection = document.getElementById('summary-section');

            // Modals
            const editMemberModal = document.getElementById('edit-member-modal');
            const editExpenseModal = document.getElementById('edit-expense-modal');
            const confirmModal = document.getElementById('confirm-modal');
            const editMemberForm = document.getElementById('edit-member-form');
            const editExpenseForm = document.getElementById('edit-expense-form');

            // --- UTILITY FUNCTIONS ---
            const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const [year, month, day] = dateString.split('-');
                return new Date(year, month - 1, day).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            };
            const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const showModal = (modal) => modal.classList.remove('hidden');
            const hideModal = (modal) => modal.classList.add('hidden');
            
            function showConfirmModal(title, message, buttons) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                const buttonsContainer = document.getElementById('confirm-buttons');
                buttonsContainer.innerHTML = ''; // Clear previous buttons

                buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    button.className = `btn ${btnConfig.class}`;
                    button.addEventListener('click', () => {
                        if(btnConfig.callback) btnConfig.callback();
                        hideModal(confirmModal);
                    });
                    buttonsContainer.appendChild(button);
                });
                showModal(confirmModal);
            }

            // --- DATA FUNCTIONS ---
            function saveData() {
                const data = JSON.stringify({ members: membersData, expenses: expensesData });
                localStorage.setItem(APP_STORAGE_KEY, data);
            }

            function loadData() {
                const data = localStorage.getItem(APP_STORAGE_KEY);
                if (data) {
                    const parsedData = JSON.parse(data);
                    membersData = parsedData.members || [];
                    expensesData = parsedData.expenses || [];
                } else {
                    membersData = initialDataFromXLSX.members;
                    expensesData = initialDataFromXLSX.expenses;
                    saveData();
                }
            }
            
            // --- UI RENDERING ---
            function populateDateFilters() {
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth() + 1; // 1-12
                const currentYear = currentDate.getFullYear();

                const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                filterMonthSelect.innerHTML = '<option value="all">Todos os Meses</option>' + 
                    months.map((month, index) => {
                        const monthValue = index + 1;
                        const isSelected = monthValue === currentMonth ? 'selected' : '';
                        return `<option value="${monthValue}" ${isSelected}>${month}</option>`;
                    }).join('');
                
                const yearsInData = [...new Set(expensesData.map(e => e.date ? new Date(e.date).getUTCFullYear() : null).filter(y => y))];
                if (!yearsInData.includes(currentYear)) {
                    yearsInData.push(currentYear);
                }
                if (yearsInData.length === 0) {
                    yearsInData.push(currentYear);
                }
                yearsInData.sort((a, b) => b - a);

                let yearOptions = '<option value="all">Todos os Anos</option>';
                yearsInData.forEach(year => {
                    const isSelected = year === currentYear ? 'selected' : '';
                    yearOptions += `<option value="${year}" ${isSelected}>${year}</option>`;
                });
                filterYearSelect.innerHTML = yearOptions;
            }

            function renderMembers() {
                membersListDiv.innerHTML = '';
                const selects = [expenseMemberSelect, filterMemberSelect, document.getElementById('edit-expense-member')];
                selects[0].innerHTML = '<option value="">Selecione um membro</option>';
                selects[1].innerHTML = '<option value="all">Todos os membros</option>';

                membersData.sort((a,b) => a.name.localeCompare(b.name)).forEach(member => {
                    const memberElement = document.createElement('div');
                    memberElement.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg';
                    const closingDayText = member.closingDay ? `<p class="text-xs text-gray-500">Fechamento: Dia ${member.closingDay}</p>` : '';
                    memberElement.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800">${member.name}</p>
                            <p class="text-sm text-green-600">${formatCurrency(member.salary)}</p>
                            ${closingDayText}
                        </div>
                        <div class="flex gap-3">
                            <button class="action-btn text-blue-500 hover:text-blue-700" data-id="${member.id}" data-action="edit-member"><i class="fas fa-edit"></i></button>
                            <button class="action-btn text-red-500 hover:text-red-700" data-id="${member.id}" data-action="delete-member"><i class="fas fa-trash"></i></button>
                        </div>`;
                    membersListDiv.appendChild(memberElement);
                    selects.forEach(s => s.innerHTML += `<option value="${member.id}">${member.name}</option>`);
                });
            }
            
            function renderExpenses() {
                const memberId = filterMemberSelect.value;
                const month = filterMonthSelect.value;
                const year = filterYearSelect.value;
                const member = memberId !== 'all' ? membersData.find(m => m.id === memberId) : null;
                const closingDay = (member && member.closingDay) ? member.closingDay : null;

                let filteredExpenses = [...expensesData];

                // 1. Filtrar por Membro (sempre)
                if (memberId !== 'all') {
                    filteredExpenses = filteredExpenses.filter(e => e.memberId === memberId);
                }

                // 2. Determinar qual lógica de filtro de data usar
                // A lógica de fatura SÓ se aplica se um MEMBRO, MÊS, ANO e DIA DE FECHAMENTO estiverem definidos
                const useBillingLogic = closingDay && memberId !== 'all' && month !== 'all' && year !== 'all';

                if (useBillingLogic) {
                    const y = parseInt(year);
                    const m = parseInt(month); // 1-12
                    // Início da fatura: dia (fechamento + 1) do mês anterior
                    const startDate = new Date(Date.UTC(y, m - 2, closingDay + 1)); // m-2 = mês anterior (JS 0-11)
                    // Fim da fatura: dia (fechamento) do mês selecionado
                    const endDate = new Date(Date.UTC(y, m - 1, closingDay, 23, 59, 59, 999)); // m-1 = mês atual (JS 0-11)

                    filteredExpenses = filteredExpenses.filter(e => {
                        if (!e.date) return false;
                        const expenseDate = new Date(e.date + 'T00:00:00Z'); // Usar T00:00:00Z e Date.UTC para consistência
                        return expenseDate >= startDate && expenseDate <= endDate;
                    });
                } else {
                    // Lógica de calendário padrão para todos os outros casos
                    if (month !== 'all') {
                        filteredExpenses = filteredExpenses.filter(e => e.date && new Date(e.date + 'T00:00:00Z').getUTCMonth() + 1 == month);
                    }
                    if (year !== 'all') {
                        filteredExpenses = filteredExpenses.filter(e => e.date && new Date(e.date + 'T00:00:00Z').getUTCFullYear() == year);
                    }
                }
                
                const totalSpent = filteredExpenses.reduce((sum, exp) => sum + exp.value, 0);
                summarySection.innerHTML = ''; 
                
                if (member && month !== 'all' && year !== 'all') {
                    const remaining = member.salary - totalSpent;
                    const summaryTitle = useBillingLogic ? 'Saldo da Fatura' : 'Saldo do Mês'; // Título dinâmico
                    summarySection.innerHTML = `<div class="p-4 bg-gray-100 rounded-lg grid grid-cols-1 md:grid-cols-3 gap-4 text-center"><div><p class="text-sm text-gray-500">Salário Mensal</p><p class="text-2xl font-bold text-green-600">${formatCurrency(member.salary)}</p></div><div><p class="text-sm text-gray-500">Total Gasto (Período)</p><p class="text-2xl font-bold text-red-600">${formatCurrency(totalSpent)}</p></div><div><p class="text-sm text-gray-500">${summaryTitle}</p><p class="text-2xl font-bold ${remaining >= 0 ? 'text-blue-600' : 'text-orange-500'}">${formatCurrency(remaining)}</p></div></div>`;
                } else if (filteredExpenses.length > 0) {
                    summarySection.innerHTML = `<div class="p-4 bg-gray-100 rounded-lg text-center"><p class="text-sm text-gray-500">Total Gasto (Período Selecionado)</p><p class="text-2xl font-bold text-red-600">${formatCurrency(totalSpent)}</p></div>`;
                }

                expensesTableBody.innerHTML = '';
                if (filteredExpenses.length === 0) {
                    noExpensesMessage.classList.remove('hidden');
                } else {
                    noExpensesMessage.classList.add('hidden');
                    filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                        const row = document.createElement('tr');
                        row.className = 'border-b hover:bg-gray-50';
                        row.innerHTML = `<td class="p-3">${expense.memberName}</td><td class="p-3"><p class="font-semibold">${expense.description}</p><p class="text-xs text-gray-500">${expense.store || ''}</p></td><td class="p-3">${formatDate(expense.date)}</td><td class="p-3 text-right text-red-600 font-mono">${formatCurrency(expense.value)}</td><td class="p-3 text-center flex justify-center gap-3"><button class="action-btn text-blue-500 hover:text-blue-700" data-id="${expense.id}" data-action="edit-expense"><i class="fas fa-edit"></i></button><button class="action-btn text-red-500 hover:text-red-700" data-id="${expense.id}" data-action="delete-expense"><i class="fas fa-trash"></i></button></td>`;
                        expensesTableBody.appendChild(row);
                    });
                }

                reportButtonContainer.innerHTML = '';
                if (memberId !== 'all' && month !== 'all' && year !== 'all' && filteredExpenses.length > 0) {
                    const selectedMemberName = filterMemberSelect.options[filterMemberSelect.selectedIndex].text;
                    const reportBtn = document.createElement('button');
                    reportBtn.className = 'btn btn-primary mt-6 w-full md:w-auto';
                    reportBtn.innerHTML = `<i class="fas fa-file-invoice"></i> Gerar Relatório para ${selectedMemberName}`;
                    reportButtonContainer.appendChild(reportBtn);
                    reportBtn.addEventListener('click', () => generateReport(memberId, month, year, filteredExpenses));
                }
            }

            function fullRender() {
                renderMembers();
                populateDateFilters();
                renderExpenses();
            }
            
            // --- EVENT LISTENERS ---
            addMemberForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const closingDay = parseInt(e.target['member-closing-day'].value, 10) || null;
                const newMember = { 
                    id: generateId(), 
                    name: e.target['member-name'].value.trim(), 
                    salary: parseFloat(e.target['member-salary'].value),
                    closingDay: closingDay 
                };
                membersData.push(newMember);
                saveData();
                fullRender();
                addMemberForm.reset();
            });

            addExpenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const memberId = e.target['expense-member'].value;
                const member = membersData.find(m => m.id === memberId);
                if (!member) return;

                const description = e.target['expense-description'].value.trim();
                const store = e.target['expense-store'].value.trim();
                const dateStr = e.target['expense-date'].value;
                const totalValue = parseFloat(e.target['expense-value'].value);
                const numInstallments = parseInt(e.target['expense-installments'].value, 10) || 1;

                if (numInstallments > 1) {
                    const groupId = generateId();
                    const installmentValue = parseFloat((totalValue / numInstallments).toFixed(2));
                    let valueSum = 0;
                    const startDate = new Date(dateStr + 'T12:00:00Z'); // Use noon UTC to avoid timezone shifts

                    for (let i = 1; i <= numInstallments; i++) {
                        const currentInstallmentDate = new Date(startDate);
                        currentInstallmentDate.setMonth(startDate.getMonth() + (i - 1));

                        let currentValue = installmentValue;
                        if (i === numInstallments) {
                            // Ajusta a última parcela para bater o valor total
                            currentValue = totalValue - valueSum;
                        } else {
                            valueSum += currentValue;
                        }

                        const newExpense = {
                            id: generateId(), memberId, memberName: member.name,
                            description: `${description} (${String(i).padStart(2, '0')}/${String(numInstallments).padStart(2, '0')})`,
                            store, date: currentInstallmentDate.toISOString().split('T')[0],
                            value: parseFloat(currentValue.toFixed(2)),
                            installmentInfo: { groupId, current: i, total: numInstallments }
                        };
                        expensesData.push(newExpense);
                    }
                } else {
                    expensesData.push({ id: generateId(), memberId, memberName: member.name, description, store, date: dateStr, value: totalValue });
                }

                saveData();
                fullRender();
                addExpenseForm.reset();
                e.target['expense-date'].valueAsDate = new Date();
            });
            
            [filterMemberSelect, filterMonthSelect, filterYearSelect].forEach(el => el.addEventListener('change', renderExpenses));
            
            membersListDiv.addEventListener('click', (e) => {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                const { id, action } = button.dataset;
                if (action === 'delete-member') {
                    showConfirmModal('Excluir Membro', 'Isso excluirá TODOS os gastos associados. Deseja continuar?', [
                        { text: 'Cancelar', class: 'btn-secondary' },
                        { text: 'Confirmar Exclusão', class: 'btn-danger', callback: () => {
                            membersData = membersData.filter(m => m.id !== id);
                            expensesData = expensesData.filter(ex => ex.memberId !== id);
                            saveData(); fullRender();
                        }}
                    ]);
                } else if (action === 'edit-member') {
                    const member = membersData.find(m => m.id === id);
                    editMemberForm['edit-member-id'].value = id;
                    editMemberForm['edit-member-name'].value = member.name;
                    editMemberForm['edit-member-salary'].value = member.salary;
                    editMemberForm['edit-member-closing-day'].value = member.closingDay || '';
                    showModal(editMemberModal);
                }
            });
            
            expensesTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                const { id, action } = button.dataset;
                const expense = expensesData.find(ex => ex.id === id);
                if (!expense) return;

                if (action === 'delete-expense') {
                    if (expense.installmentInfo && expense.installmentInfo.groupId) {
                        showConfirmModal('Excluir Gasto Parcelado', 'Como deseja excluí-lo?', [
                            { text: 'Cancelar', class: 'btn-secondary' },
                            { text: 'Excluir Apenas Esta', class: 'btn-danger', callback: () => {
                                expensesData = expensesData.filter(ex => ex.id !== id);
                                saveData(); renderExpenses();
                            }},
                            { text: 'Excluir Esta e Futuras', class: 'btn-danger', callback: () => {
                                expensesData = expensesData.filter(ex => !(ex.installmentInfo && ex.installmentInfo.groupId === expense.installmentInfo.groupId && ex.installmentInfo.current >= expense.installmentInfo.current));
                                saveData(); renderExpenses();
                            }}
                        ]);
                    } else {
                        showConfirmModal('Excluir Gasto', 'Tem certeza que deseja excluir este gasto?', [
                            { text: 'Cancelar', class: 'btn-secondary' },
                            { text: 'Confirmar', class: 'btn-danger', callback: () => {
                                expensesData = expensesData.filter(ex => ex.id !== id);
                                saveData(); renderExpenses();
                            }}
                        ]);
                    }
                } else if (action === 'edit-expense') {
                    const editInstallmentInfoDiv = document.getElementById('edit-installment-info');
                    if (expense.installmentInfo) {
                        editInstallmentInfoDiv.textContent = `Editando Parcela ${expense.installmentInfo.current} de ${expense.installmentInfo.total}. A alteração afetará apenas esta parcela.`;
                        editInstallmentInfoDiv.classList.remove('hidden');
                    } else {
                        editInstallmentInfoDiv.classList.add('hidden');
                    }
                    document.getElementById('edit-expense-member').innerHTML = membersData.map(m => `<option value="${m.id}" ${m.id === expense.memberId ? 'selected' : ''}>${m.name}</option>`).join('');
                    editExpenseForm['edit-expense-id'].value = id;
                    editExpenseForm['edit-expense-member'].value = expense.memberId;
                    editExpenseForm['edit-expense-description'].value = expense.description;
                    editExpenseForm['edit-expense-store'].value = expense.store;
                    editExpenseForm['edit-expense-date'].value = expense.date;
                    editExpenseForm['edit-expense-value'].value = expense.value;
                    showModal(editExpenseModal);
                }
            });

            editMemberForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = e.target['edit-member-id'].value;
                const memberIndex = membersData.findIndex(m => m.id === id);
                if (memberIndex > -1) {
                    const newName = e.target['edit-member-name'].value;
                    membersData[memberIndex].name = newName;
                    membersData[memberIndex].salary = parseFloat(e.target['edit-member-salary'].value);
                    membersData[memberIndex].closingDay = parseInt(e.target['edit-member-closing-day'].value, 10) || null;
                    expensesData.forEach(expense => { if (expense.memberId === id) { expense.memberName = newName; } });
                    saveData();
                    fullRender();
                }
                hideModal(editMemberModal);
            });
            
            editExpenseForm.addEventListener('submit', (e) => {
                 e.preventDefault();
                 const id = e.target['edit-expense-id'].value;
                 const memberId = e.target['edit-expense-member'].value;
                 const member = membersData.find(m => m.id === memberId);
                 const expenseIndex = expensesData.findIndex(ex => ex.id === id);
                 if (expenseIndex > -1) {
                    expensesData[expenseIndex] = { ...expensesData[expenseIndex], memberId, memberName: member.name, description: e.target['edit-expense-description'].value, store: e.target['edit-expense-store'].value, date: e.target['edit-expense-date'].value, value: parseFloat(e.target['edit-expense-value'].value) };
                    saveData();
                    renderExpenses();
                 }
                 hideModal(editExpenseModal);
            });

            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', () => { hideModal(btn.closest('.modal-overlay')); });
            });
            
            document.getElementById('confirm-cancel-btn')?.addEventListener('click', () => hideModal(confirmModal));

            // --- REPORT & PDF ---
            function generateReport(memberId, month, year, expenses) {
                const member = membersData.find(m => m.id === memberId);
                if (!member) return;
                const totalExpenses = expenses.reduce((sum, exp) => sum + exp.value, 0);
                const remainingBalance = member.salary - totalExpenses;
                const faturaText = member.closingDay ? `FATURA (FECHAMENTO DIA ${member.closingDay}):` : 'MÊS/ANO:';
                
                reportContent.innerHTML = `<div class="text-center mb-4"><h3 class="text-lg font-bold">ANDERSON YOSHI CONTABILIDADE</h3><p class="text-sm">RELATÓRIO DE GASTOS PESSOAIS</p></div><div class="border-t border-b border-dashed border-gray-400 my-2 py-2 text-sm"><p><strong>NOME:</strong> ${member.name.toUpperCase()}</p><p><strong>${faturaText}</strong> ${String(month).padStart(2, '0')}/${year}</p><p><strong>SALÁRIO:</strong> ${formatCurrency(member.salary)}</p></div><table class="w-full text-sm my-2"><thead><tr class="border-b border-dashed border-gray-400"><th class="text-left py-1">DATA</th><th class="text-left py-1">DESCRIÇÃO</th><th class="text-right py-1">VALOR</th></tr></thead><tbody>${expenses.sort((a,b) => new Date(a.date) - new Date(b.date)).map(exp => `<tr><td class="py-1">${formatDate(exp.date)}</td><td class="py-1">${exp.description} ${exp.store ? `(${exp.store})` : ''}</td><td class="py-1 text-right">${formatCurrency(exp.value)}</td></tr>`).join('')}</tbody></table><div class="border-t border-dashed border-gray-400 mt-2 pt-2 text-right"><p><strong>TOTAL GASTOS:</strong> ${formatCurrency(totalExpenses)}</p><p class="font-bold ${remainingBalance >= 0 ? 'text-green-600' : 'text-red-600'}"><strong>SALDO RESTANTE:</strong> ${formatCurrency(remainingBalance)}</p></div>`;
                printPdfBtn.onclick = () => exportReportToPDF(member, month, year, expenses, totalExpenses, remainingBalance);
                showModal(reportModal);
            }
            function exportReportToPDF(member, month, year, expenses, totalExpenses, remainingBalance) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const tableData = expenses.sort((a,b) => new Date(a.date) - new Date(b.date)).map(e => [formatDate(e.date), `${e.description} ${e.store ? `(${e.store})` : ''}`, { content: formatCurrency(e.value), styles: { halign: 'right' } }]);
                doc.setFontSize(16); doc.text("Relatório de Gastos Pessoais", 105, 20, { align: 'center' });
                doc.setFontSize(10); 
                doc.text(`NOME: ${member.name.toUpperCase()}`, 14, 35);
                const faturaText = member.closingDay ? `FATURA (Fechamento dia ${member.closingDay}): ${String(month).padStart(2, '0')}/${year}` : `MÊS/ANO: ${String(month).padStart(2, '0')}/${year}`;
                doc.text(faturaText, 14, 42); 
                doc.text(`SALÁRIO: ${formatCurrency(member.salary)}`, 14, 49);
                doc.autoTable({ startY: 55, head: [['Data', 'Descrição', 'Valor (R$)']], body: tableData, theme: 'striped', headStyles: { fillColor: [79, 70, 229] } });
                const finalY = doc.lastAutoTable.finalY;
                doc.setFontSize(12); doc.text(`Total de Gastos: ${formatCurrency(totalExpenses)}`, 195, finalY + 10, { align: 'right' });
                doc.setFont(undefined, 'bold'); doc.setTextColor(remainingBalance >= 0 ? 34 : 220, remainingBalance >= 0 ? 197 : 38, remainingBalance >= 0 ? 94: 38);
                doc.text(`Saldo Restante: ${formatCurrency(remainingBalance)}`, 195, finalY + 17, { align: 'right' });
                doc.save(`relatorio_${member.name.replace(/\s+/g, '_')}_${month}-${year}.pdf`);
            }
            
            // --- BACKUP & RESTORE ---
            backupBtn.addEventListener('click', () => {
                const blob = new Blob([JSON.stringify({ members: membersData, expenses: expensesData }, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = `backup_gastos_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            restoreInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.members && data.expenses) {
                             showConfirmModal('Restaurar Backup', 'Isso substituirá TODOS os dados atuais. Deseja continuar?', [
                                { text: 'Cancelar', class: 'btn-secondary' },
                                { text: 'Confirmar Restauração', class: 'btn-danger', callback: () => {
                                    membersData = data.members; expensesData = data.expenses;
                                    saveData(); fullRender();
                                }}
                             ]);
                        } else { console.error("Arquivo de backup inválido."); }
                    } catch (err) { console.error("Erro ao ler o arquivo de backup:", err); } 
                    finally { restoreInput.value = ''; }
                };
                reader.readAsText(file);
            });

            // --- APP INITIALIZATION ---
            function init() {
                loadData();
                fullRender();
                document.getElementById('expense-date').valueAsDate = new Date();
            }

            init();
        });
    </script>
</body>
</html>

